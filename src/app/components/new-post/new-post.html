<form
  class="border-2 rounded-xl p-4"
  [formGroup]="postForm"
  (ngSubmit)="onSubmitPost()"
>
  <div hlmFieldGroup>
    <fieldset hlmFieldSet>
      <legend hlmFieldLegend>New Post</legend>
      <p hlmFieldDescription>Posts can be edited and deleted by the author</p>

      <div hlmFieldGroup>
        <div class="grid grid-cols-6 gap-2">
          <div hlmField class="col-span-1">
            <label hlmFieldLabel for="field-preview-name-on-card"
              >Name of Author</label
            >
            <input [value]="authorName" readonly />
          </div>
          <div hlmField class="col-span-1">
            <div hlmField>
              <label hlmFieldLabel for="field-exp-topic--trigger"
                >Select Topic</label
              >
              <brn-select
                id="field-exp-topic"
                class="inline-block"
                placeholder="Topic..."
                formControlName="topic"
              >
                <hlm-select-trigger class="w-full">
                  <hlm-select-value />
                </hlm-select-trigger>
                <hlm-select-content>
                  @for (topic of topics(); track topic) {

                  <hlm-option [value]="topic">
                    {{topic | titlecase}}
                  </hlm-option>
                  }
                </hlm-select-content>
              </brn-select>
            </div>
            <app-form-field-error
              [control]="postForm.controls.topic"
              label="Topic"
            />
          </div>
          <div hlmField class="col-span-4">
            <label hlmFieldLabel for="field-title-of-post">Title of Post</label>
            <input
              hlmInput
              id="field-title-of-post"
              type="text"
              formControlName="title"
            />
            <app-form-field-error
              [control]="postForm.controls.title"
              label="Title"
            />
          </div>
        </div>
      </div>
    </fieldset>
    <hlm-field-separator />

    <fieldset hlmFieldSet>
      <div hlmFieldGroup>
        <div hlmField>
          <label hlmFieldLabel for="field-post-content">Content of post</label>
          <textarea
            hlmTextarea
            class="resize-none"
            id="field-post-content"
            formControlName="content"
          ></textarea>
        </div>
      </div>
      <app-form-field-error
        [control]="postForm.controls.content"
        label="Content"
      />
    </fieldset>
    <div class="flex gap-4 items-start">
      <div hlmField class="flex-1">
        <label hlmFieldLabel for="field-post-image"
          >Only Publicly Hosted Image Url for now</label
        >
        <input
          hlmInput
          id="field-post-image"
          type="text"
          formControlName="image"
          placeholder="https://example.com/image.jpg"
        />
      </div>

      <!-- Image Preview -->
      @if(postForm.get('image')?.value) {
      <div
        class="w-48 h-32 border-2 border-dashed border-muted-foreground/25 rounded-xl p-2 bg-muted/10"
      >
        <div class="relative w-full h-full bg-muted rounded-lg overflow-hidden">
          <img
            [src]="postForm.get('image')?.value"
            [alt]="postForm.get('title')?.value || 'Post image preview'"
            class="w-full h-full object-cover object-center"
            [class.hidden]="imageError"
            (error)="onImageError($event)"
            (load)="onImageLoad($event)"
          />
          <!-- Loading placeholder -->
          @if(!imageLoaded && !imageError) {
          <div
            class="absolute inset-0 flex items-center justify-center bg-muted animate-pulse"
          >
            <span class="text-muted-foreground text-xs">Loading...</span>
          </div>
          }

          <!-- Error placeholder -->
          @if(imageError) {
          <div
            class="absolute inset-0 flex items-center justify-center bg-destructive/10"
          >
            <span class="text-destructive text-xs">Failed to load image</span>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <div hlmField orientation="horizontal">
      <hlm-toaster />
      <button
        class="cursor-pointer active:scale-80 duration-300"
        hlmBtn
        type="submit"
      >
        Submit
      </button>
      <hlm-toaster />
      <button
        class="cursor-pointer active:scale-80 duration-300"
        hlmBtn
        variant="outline"
        type="button"
        (click)="onResetForm()"
      >
        Reset
      </button>
    </div>
  </div>
</form>
